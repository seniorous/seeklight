<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="850" height="450" viewBox="0 0 850 450">
  <defs>
    <filter id="shadow3" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="2" dy="3" stdDeviation="4" flood-opacity="0.12"/>
    </filter>
    <linearGradient id="prefGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#8B5CF6;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#A855F7;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="emaGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#14B8A6;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#10B981;stop-opacity:1" />
    </linearGradient>
    <marker id="arrowPurple" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#8B5CF6"/>
    </marker>
  </defs>
  
  <!-- 背景 -->
  <rect width="850" height="450" fill="#F9FAFB"/>
  
  <!-- 标题 -->
  <text x="425" y="35" font-family="SimHei, Microsoft YaHei" font-size="20" font-weight="bold" fill="#1F2937" text-anchor="middle">隐式记忆层偏好学习机制 (UserPreference)</text>
  
  <!-- 左侧：数据模型 -->
  <g transform="translate(30, 60)">
    <rect x="0" y="0" width="300" height="250" rx="10" fill="#FFFFFF" filter="url(#shadow3)" stroke="#8B5CF6" stroke-width="2"/>
    <rect x="0" y="0" width="300" height="40" rx="10" fill="url(#prefGrad)"/>
    <rect x="0" y="30" width="300" height="10" fill="url(#prefGrad)"/>
    <text x="150" y="28" font-family="SimHei" font-size="14" fill="#FFFFFF" text-anchor="middle" font-weight="bold">偏好数据模型</text>
    
    <!-- 字段 -->
    <g transform="translate(15, 55)">
      <rect x="0" y="0" width="270" height="35" rx="5" fill="#8B5CF6" opacity="0.1"/>
      <circle cx="15" cy="17" r="8" fill="#8B5CF6"/>
      <text x="15" y="22" font-family="Consolas" font-size="8" fill="#FFFFFF" text-anchor="middle">PK</text>
      <text x="35" y="15" font-family="SimHei" font-size="12" fill="#1F2937" font-weight="bold">sceneType</text>
      <text x="35" y="30" font-family="SimSun" font-size="10" fill="#6B7280">场景类型: food / landscape / portrait</text>
    </g>
    <g transform="translate(15, 100)">
      <rect x="0" y="0" width="270" height="35" rx="5" fill="#14B8A6" opacity="0.1"/>
      <circle cx="15" cy="17" r="8" fill="#14B8A6"/>
      <text x="15" y="22" font-family="Consolas" font-size="6" fill="#FFFFFF" text-anchor="middle">Vec</text>
      <text x="35" y="15" font-family="SimHei" font-size="12" fill="#1F2937" font-weight="bold">filterPreference</text>
      <text x="35" y="30" font-family="SimSun" font-size="10" fill="#6B7280">滤镜偏好向量 (EMA更新)</text>
    </g>
    <g transform="translate(15, 145)">
      <rect x="0" y="0" width="130" height="35" rx="5" fill="#F59E0B" opacity="0.1"/>
      <text x="65" y="15" font-family="SimHei" font-size="11" fill="#1F2937" text-anchor="middle" font-weight="bold">brightnessAvg</text>
      <text x="65" y="30" font-family="SimSun" font-size="9" fill="#6B7280" text-anchor="middle">亮度均值</text>
      
      <rect x="140" y="0" width="130" height="35" rx="5" fill="#F59E0B" opacity="0.1"/>
      <text x="205" y="15" font-family="SimHei" font-size="11" fill="#1F2937" text-anchor="middle" font-weight="bold">contrastAvg</text>
      <text x="205" y="30" font-family="SimSun" font-size="9" fill="#6B7280" text-anchor="middle">对比度均值</text>
    </g>
    <g transform="translate(15, 190)">
      <rect x="0" y="0" width="130" height="35" rx="5" fill="#6B7280" opacity="0.1"/>
      <text x="65" y="15" font-family="SimHei" font-size="11" fill="#1F2937" text-anchor="middle" font-weight="bold">updateCount</text>
      <text x="65" y="30" font-family="SimSun" font-size="9" fill="#6B7280" text-anchor="middle">样本数量</text>
      
      <rect x="140" y="0" width="130" height="35" rx="5" fill="#6B7280" opacity="0.1"/>
      <text x="205" y="15" font-family="SimHei" font-size="11" fill="#1F2937" text-anchor="middle" font-weight="bold">lastUpdated</text>
      <text x="205" y="30" font-family="SimSun" font-size="9" fill="#6B7280" text-anchor="middle">最后更新时间</text>
    </g>
  </g>
  
  <!-- 箭头 -->
  <path d="M340,185 L380,185" stroke="#8B5CF6" stroke-width="2" marker-end="url(#arrowPurple)"/>
  <text x="360" y="175" font-family="SimSun" font-size="10" fill="#8B5CF6" text-anchor="middle">更新</text>
  
  <!-- 右侧：EMA算法 -->
  <g transform="translate(390, 60)">
    <rect x="0" y="0" width="430" height="250" rx="10" fill="#FFFFFF" filter="url(#shadow3)" stroke="#14B8A6" stroke-width="2"/>
    <rect x="0" y="0" width="430" height="40" rx="10" fill="url(#emaGrad)"/>
    <rect x="0" y="30" width="430" height="10" fill="url(#emaGrad)"/>
    <text x="215" y="28" font-family="SimHei" font-size="14" fill="#FFFFFF" text-anchor="middle" font-weight="bold">EMA指数移动平均更新算法</text>
    
    <!-- 核心公式 -->
    <g transform="translate(15, 55)">
      <rect x="0" y="0" width="400" height="60" rx="8" fill="#14B8A6" opacity="0.15"/>
      <text x="200" y="25" font-family="SimHei" font-size="14" fill="#1F2937" text-anchor="middle" font-weight="bold">核心公式</text>
      <text x="200" y="48" font-family="Consolas" font-size="15" fill="#14B8A6" text-anchor="middle" font-weight="bold">Pref_new = α × Edit + (1-α) × Pref_old</text>
    </g>
    
    <!-- 参数说明 -->
    <g transform="translate(15, 125)">
      <rect x="0" y="0" width="130" height="55" rx="6" fill="#8B5CF6" opacity="0.1"/>
      <text x="65" y="20" font-family="SimHei" font-size="12" fill="#8B5CF6" text-anchor="middle" font-weight="bold">α = 0.2</text>
      <text x="65" y="38" font-family="SimSun" font-size="10" fill="#6B7280" text-anchor="middle">平滑系数</text>
      <text x="65" y="50" font-family="SimSun" font-size="9" fill="#6B7280" text-anchor="middle">新数据权重20%</text>
      
      <rect x="140" y="0" width="130" height="55" rx="6" fill="#10B981" opacity="0.1"/>
      <text x="205" y="20" font-family="SimHei" font-size="12" fill="#10B981" text-anchor="middle" font-weight="bold">Edit</text>
      <text x="205" y="38" font-family="SimSun" font-size="10" fill="#6B7280" text-anchor="middle">本次修图参数</text>
      <text x="205" y="50" font-family="SimSun" font-size="9" fill="#6B7280" text-anchor="middle">滤镜/亮度/对比度</text>
      
      <rect x="280" y="0" width="120" height="55" rx="6" fill="#3B82F6" opacity="0.1"/>
      <text x="340" y="20" font-family="SimHei" font-size="12" fill="#3B82F6" text-anchor="middle" font-weight="bold">Pref</text>
      <text x="340" y="38" font-family="SimSun" font-size="10" fill="#6B7280" text-anchor="middle">历史偏好</text>
      <text x="340" y="50" font-family="SimSun" font-size="9" fill="#6B7280" text-anchor="middle">保留80%权重</text>
    </g>
    
    <!-- 特点说明 -->
    <g transform="translate(15, 195)">
      <circle cx="15" cy="12" r="6" fill="#10B981"/>
      <text x="30" y="16" font-family="SimSun" font-size="11" fill="#1F2937">纯统计方法，无ML依赖</text>
      
      <circle cx="215" cy="12" r="6" fill="#10B981"/>
      <text x="230" y="16" font-family="SimSun" font-size="11" fill="#1F2937">Room数据库存储</text>
      
      <circle cx="15" cy="35" r="6" fill="#10B981"/>
      <text x="30" y="39" font-family="SimSun" font-size="11" fill="#1F2937">按场景分组，独立学习</text>
      
      <circle cx="215" cy="35" r="6" fill="#10B981"/>
      <text x="230" y="39" font-family="SimSun" font-size="11" fill="#1F2937">实现复杂度低</text>
    </g>
  </g>
  
  <!-- 底部：工作流程 -->
  <g transform="translate(30, 330)">
    <rect x="0" y="0" width="790" height="105" rx="10" fill="#FFFFFF" filter="url(#shadow3)"/>
    <text x="395" y="28" font-family="SimHei" font-size="14" fill="#1F2937" text-anchor="middle" font-weight="bold">偏好学习触发流程</text>
    
    <!-- 流程步骤 -->
    <g transform="translate(30, 45)">
      <rect x="0" y="0" width="140" height="50" rx="8" fill="#8B5CF6" opacity="0.9"/>
      <text x="70" y="22" font-family="SimHei" font-size="12" fill="#FFFFFF" text-anchor="middle" font-weight="bold">用户修图</text>
      <text x="70" y="40" font-family="SimSun" font-size="10" fill="#FFFFFF" text-anchor="middle">选择滤镜/调参</text>
    </g>
    <path d="M175,70 L210,70" stroke="#6B7280" stroke-width="2" marker-end="url(#arrowGray)"/>
    
    <g transform="translate(215, 45)">
      <rect x="0" y="0" width="140" height="50" rx="8" fill="#14B8A6" opacity="0.9"/>
      <text x="70" y="22" font-family="SimHei" font-size="12" fill="#FFFFFF" text-anchor="middle" font-weight="bold">识别场景类型</text>
      <text x="70" y="40" font-family="SimSun" font-size="10" fill="#FFFFFF" text-anchor="middle">food/landscape/...</text>
    </g>
    <path d="M360,70 L395,70" stroke="#6B7280" stroke-width="2" marker-end="url(#arrowGray)"/>
    
    <g transform="translate(400, 45)">
      <rect x="0" y="0" width="140" height="50" rx="8" fill="#10B981" opacity="0.9"/>
      <text x="70" y="22" font-family="SimHei" font-size="12" fill="#FFFFFF" text-anchor="middle" font-weight="bold">EMA更新偏好</text>
      <text x="70" y="40" font-family="SimSun" font-size="10" fill="#FFFFFF" text-anchor="middle">α=0.2 平滑更新</text>
    </g>
    <path d="M545,70 L580,70" stroke="#6B7280" stroke-width="2" marker-end="url(#arrowGray)"/>
    
    <g transform="translate(585, 45)">
      <rect x="0" y="0" width="170" height="50" rx="8" fill="#3B82F6" opacity="0.9"/>
      <text x="85" y="22" font-family="SimHei" font-size="12" fill="#FFFFFF" text-anchor="middle" font-weight="bold">下次修图时推荐</text>
      <text x="85" y="40" font-family="SimSun" font-size="10" fill="#FFFFFF" text-anchor="middle">场景化个性化建议</text>
    </g>
  </g>
</svg>