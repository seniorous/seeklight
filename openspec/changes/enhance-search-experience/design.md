# Design: å¢å¼ºæœç´¢ä½“éªŒæŠ€æœ¯è®¾è®¡

## Context

SeekLight å·²å®ç°ç«¯ä¾§ VLM (Qwen3-VL-2B) è¿›è¡Œå›¾åƒæè¿°ç”Ÿæˆï¼Œç°éœ€æ‰©å±•æœç´¢èƒ½åŠ›ã€‚å½“å‰æŠ€æœ¯æ ˆï¼š
- MNN æ¨ç†æ¡†æ¶ï¼ˆå·²é›†æˆï¼‰
- Room æœ¬åœ°æ•°æ®åº“ï¼ˆå·²é›†æˆï¼‰
- Jetpack Compose UIï¼ˆå·²é›†æˆï¼‰

### Stakeholders
- æœ€ç»ˆç”¨æˆ·ï¼šéœ€è¦é«˜æ•ˆæ‰¾åˆ°è®°å¿†
- å¼€å‘è€…ï¼šéœ€è¦å¯ç»´æŠ¤çš„æ¶æ„
- äº§å“ï¼šéœ€è¦å·®å¼‚åŒ–ç«äº‰åŠ›

### Constraints
- çº¯ç«¯ä¾§è¿è¡Œï¼Œæ— ç½‘ç»œä¾èµ–
- Android 7.0+ å…¼å®¹
- åº”ç”¨ä½“ç§¯æ§åˆ¶åœ¨ 100MB ä»¥å†…ï¼ˆå«æ¨¡å‹ï¼‰

## Goals / Non-Goals

### Goals
- G1: å®ç°è¯­ä¹‰çº§åˆ«çš„è®°å¿†æœç´¢
- G2: æä¾›ç›´è§‚çš„æ—¶é—´ç­›é€‰äº¤äº’
- G3: å»ºç«‹å¯æ‰©å±•çš„æ ‡ç­¾ç®¡ç†ç³»ç»Ÿ
- G4: ä¿æŒæœç´¢å“åº”æ—¶é—´ < 500ms

### Non-Goals
- NG1: æœ¬é˜¶æ®µä¸å®ç°äº‘ç«¯æœç´¢
- NG2: ä¸æ”¯æŒå›¾åƒå†…å®¹ç›´æ¥æœç´¢ï¼ˆä»¥å›¾æœå›¾ï¼‰
- NG3: ä¸å®ç°è‡ªç„¶è¯­è¨€è§£æï¼ˆå¦‚"å»å¹´å¤å¤©"â†’æ—¶é—´èŒƒå›´ï¼‰

## Decisions

### D1: Embedding æ¨¡å‹é€‰æ‹©

**Decision**: ä½¿ç”¨ `all-MiniLM-L6-v2` çš„ ONNX é‡åŒ–ç‰ˆæœ¬

**Alternatives Considered**:

| æ–¹æ¡ˆ | æ¨¡å‹å¤§å° | æ¨ç†é€Ÿåº¦ | å‘é‡ç»´åº¦ | ä¸­æ–‡æ”¯æŒ |
|------|----------|----------|----------|----------|
| all-MiniLM-L6-v2 (ONNX) | ~25MB | ~50ms | 384 | ä¸€èˆ¬ |
| paraphrase-multilingual-MiniLM | ~470MB | ~100ms | 384 | ä¼˜ç§€ |
| text2vec-chinese-paraphrase | ~400MB | ~100ms | 768 | ä¼˜ç§€ |
| BGE-small-zh | ~95MB | ~80ms | 512 | ä¼˜ç§€ |

**Rationale**:
- MiniLM ä½“ç§¯æœ€å°ï¼Œé€‚åˆç«¯ä¾§éƒ¨ç½²
- 384 ç»´åº¦åœ¨å‡†ç¡®æ€§å’Œå­˜å‚¨é—´å–å¾—å¹³è¡¡
- ä¸­æ–‡æ”¯æŒè™½ä¸€èˆ¬ï¼Œä½† AI ç”Ÿæˆçš„æè¿°å·²æ˜¯ç»“æ„åŒ–æ–‡æœ¬
- å¯åç»­å‡çº§ä¸ºå¤šè¯­è¨€æ¨¡å‹

**Fallback**: å¦‚æœä¸­æ–‡æ•ˆæœä¸ä½³ï¼Œå‡çº§ä¸º `BGE-small-zh`

### D2: å‘é‡å­˜å‚¨æ–¹æ¡ˆ

**Decision**: ä½¿ç”¨ Room æ‰©å±•è¡¨ + å†…å­˜ç¼“å­˜

**Architecture**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Room Database                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ image_memories (å·²æœ‰)                        â”‚
â”‚ â”œâ”€â”€ id, description, tags, createdAt...    â”‚
â”‚                                             â”‚
â”‚ memory_embeddings (æ–°å¢)                     â”‚
â”‚ â”œâ”€â”€ memory_id (FK)                          â”‚
â”‚ â”œâ”€â”€ embedding_blob (BLOB, 384*4 bytes)     â”‚
â”‚ â””â”€â”€ model_version (TEXT)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           EmbeddingCache (å†…å­˜)              â”‚
â”‚ Map<Long, FloatArray> - æŒ‰éœ€åŠ è½½            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Alternatives Considered**:
- SQLite-VSS æ‰©å±•ï¼šAndroid åŸç”Ÿä¸æ”¯æŒï¼Œéœ€è¦ NDK ç¼–è¯‘
- ç‹¬ç«‹å‘é‡æ•°æ®åº“ï¼ˆChroma/Milvusï¼‰ï¼šä¾èµ–è¿‡é‡
- çº¯æ–‡ä»¶å­˜å‚¨ï¼šç¼ºä¹äº‹åŠ¡æ”¯æŒ

**Rationale**:
- Room å·²é›†æˆï¼Œæ— é¢å¤–ä¾èµ–
- BLOB å­˜å‚¨äºŒè¿›åˆ¶å‘é‡é«˜æ•ˆ
- å†…å­˜ç¼“å­˜é¿å…é¢‘ç¹ IO
- æ”¯æŒç‰ˆæœ¬ç®¡ç†ï¼ˆæ¨¡å‹å‡çº§æ—¶é‡æ–°ç”Ÿæˆï¼‰

### D3: æœç´¢ç­–ç•¥

**Decision**: æ··åˆæœç´¢ï¼ˆHybrid Searchï¼‰

```
ç”¨æˆ·è¾“å…¥ "å® ç‰©"
    â”‚
    â”œâ”€â–º å…³é”®è¯æœç´¢ (SQL LIKE)
    â”‚   â””â”€â”€ åŒ¹é…æè¿°/æ ‡ç­¾åŒ…å«"å® ç‰©"çš„è®°å¿†
    â”‚
    â””â”€â–º è¯­ä¹‰æœç´¢ (Cosine Similarity)
        â””â”€â”€ åŒ¹é…è¯­ä¹‰ç›¸è¿‘çš„è®°å¿†ï¼ˆçŒ«ã€ç‹—ã€å…”å­...ï¼‰
    â”‚
    â–¼
èåˆæ’åº (Score Fusion)
    â”‚
    â””â”€â–º æœ€ç»ˆç»“æœï¼ˆå»é‡ + Top-Kï¼‰
```

**Scoring Formula**:
```
final_score = Î± Ã— keyword_score + (1-Î±) Ã— semantic_score
where Î± = 0.3 (å¯é…ç½®)
```

**Rationale**:
- çº¯è¯­ä¹‰æœç´¢å¯èƒ½é—æ¼ç²¾ç¡®åŒ¹é…
- çº¯å…³é”®è¯æœç´¢ç¼ºä¹æ³›åŒ–èƒ½åŠ›
- æ··åˆæ–¹æ¡ˆå…¼é¡¾ç²¾ç¡®æ€§å’Œå¬å›ç‡

### D4: æ—¶é—´ç­›é€‰ UI

**Decision**: åº•éƒ¨å¼¹å‡ºæ—¥å†ç»„ä»¶ï¼ˆBottom Sheetï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®°å¿†åº“                          [ç­›é€‰] [+] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ” æœç´¢è®°å¿†...                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ä»Šå¤©] [æœ¬å‘¨] [æœ¬æœˆ] [ä»Šå¹´] [è‡ªå®šä¹‰]         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è®°å¿†åˆ—è¡¨...                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        â–¼ ç‚¹å‡» [è‡ªå®šä¹‰]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚               é€‰æ‹©æ—¶é—´èŒƒå›´                   â”‚
â”‚                                             â”‚
â”‚   å¼€å§‹: [2024-01-01]  ç»“æŸ: [2024-12-31]   â”‚
â”‚                                             â”‚
â”‚          [  å–æ¶ˆ  ]  [  ç¡®å®š  ]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Rationale**:
- å¿«æ·é€‰é¡¹è¦†ç›– 80% ä½¿ç”¨åœºæ™¯
- è‡ªå®šä¹‰æ—¥æœŸæ»¡è¶³ç²¾ç¡®éœ€æ±‚
- Bottom Sheet ä¸é®æŒ¡ä¸»ç•Œé¢

### D5: æ ‡ç­¾åˆ†ç±»ä½“ç³»

**Decision**: é¢„å®šä¹‰åˆ†ç±» + è‡ªåŠ¨å½’ç±»

**Categories**:
```kotlin
enum class TagCategory(val displayName: String, val keywords: List<String>) {
    PERSON("äººç‰©", listOf("äºº", "å¥³", "ç”·", "å­©å­", "æœ‹å‹", "å®¶äºº")),
    PLACE("åœ°ç‚¹", listOf("å±±", "æµ·", "åŸå¸‚", "å…¬å›­", "é¤å…", "å®¶")),
    OBJECT("ç‰©å“", listOf("è½¦", "èŠ±", "ä¹¦", "æ‰‹æœº", "é£Ÿç‰©", "è¡£æœ")),
    ACTIVITY("æ´»åŠ¨", listOf("æ—…è¡Œ", "èšä¼š", "è¿åŠ¨", "å·¥ä½œ", "å­¦ä¹ ")),
    EMOTION("æƒ…ç»ª", listOf("å¼€å¿ƒ", "å¿«ä¹", "ç¾å¥½", "æ¸©é¦¨", "æ„ŸåŠ¨")),
    OTHER("å…¶ä»–", emptyList())
}
```

**Auto-Classification Logic**:
```kotlin
fun classifyTag(tag: String): TagCategory {
    return TagCategory.values().find { category ->
        category.keywords.any { keyword -> 
            tag.contains(keyword) 
        }
    } ?: TagCategory.OTHER
}
```

**Rationale**:
- é¢„å®šä¹‰åˆ†ç±»æä¾›ç»“æ„åŒ–ç®¡ç†
- è‡ªåŠ¨å½’ç±»å‡å°‘ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ
- æ”¯æŒç”¨æˆ·æ‰‹åŠ¨è°ƒæ•´åˆ†ç±»

## Architecture

### æ¨¡å—ä¾èµ–å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        UI Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ HistoryScreenâ”‚  â”‚TagManagementâ”‚  â”‚ SemanticSearchBar   â”‚ â”‚
â”‚  â”‚ (modified)  â”‚  â”‚   Screen    â”‚  â”‚                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                   â”‚
          â–¼                â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ViewModel Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚HistoryVM    â”‚  â”‚TagManagementâ”‚  â”‚   SearchViewModel   â”‚ â”‚
â”‚  â”‚ (modified)  â”‚  â”‚     VM      â”‚  â”‚       (new)         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                   â”‚
          â–¼                â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Domain Layer                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              SearchUseCase (new)                     â”‚   â”‚
â”‚  â”‚  - hybridSearch(query, timeRange, tags)             â”‚   â”‚
â”‚  â”‚  - generateEmbedding(text)                          â”‚   â”‚
â”‚  â”‚  - findSimilar(embedding, topK)                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Data Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ImageMemoryRepoâ”‚  â”‚ EmbeddingRepo â”‚  â”‚TextEmbeddingBridgeâ”‚
â”‚  â”‚  (modified)   â”‚  â”‚    (new)      â”‚  â”‚     (new)      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚                  â”‚                   â”‚          â”‚
â”‚          â–¼                  â–¼                   â–¼          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Room Database         â”‚    â”‚  ONNX Runtime   â”‚  â”‚
â”‚  â”‚  image_memories               â”‚    â”‚  MiniLM Model   â”‚  â”‚
â”‚  â”‚  memory_embeddings (new)      â”‚    â”‚                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµï¼ˆè¯­ä¹‰æœç´¢ï¼‰

```
User Input: "å® ç‰©"
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SearchViewModel    â”‚
â”‚  onSearch("å® ç‰©")   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SearchUseCase     â”‚
â”‚  hybridSearch()     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
     â”‚           â”‚
     â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Keyword  â”‚ â”‚TextEmbeddingBridgeâ”‚
â”‚Search   â”‚ â”‚generateEmbedding()â”‚
â”‚(SQL)    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â”‚
     â”‚               â–¼
     â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚      â”‚ EmbeddingRepo   â”‚
     â”‚      â”‚ findSimilar()   â”‚
     â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚               â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Score Fusion   â”‚
    â”‚  Deduplication  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ UI State Update â”‚
    â”‚ Flow<List<Memory>>â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Risks / Trade-offs

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| ONNX Runtime å…¼å®¹æ€§é—®é¢˜ | ä¸­ | é«˜ | æå‰åœ¨å¤šè®¾å¤‡æµ‹è¯•ï¼Œå‡†å¤‡ MNN å¤‡é€‰æ–¹æ¡ˆ |
| å‘é‡æœç´¢å†…å­˜å ç”¨è¿‡é«˜ | ä¸­ | ä¸­ | å®ç°åˆ†é¡µåŠ è½½ï¼Œé™åˆ¶ç¼“å­˜å¤§å° |
| ä¸­æ–‡è¯­ä¹‰åŒ¹é…æ•ˆæœå·® | é«˜ | ä¸­ | åç»­å‡çº§å¤šè¯­è¨€æ¨¡å‹ï¼Œæä¾›åé¦ˆæœºåˆ¶ |
| Room Migration æ•°æ®ä¸¢å¤± | ä½ | é«˜ | ç¼–å†™å®Œæ•´è¿ç§»æµ‹è¯•ï¼Œæ”¯æŒå¯¼å‡ºå¤‡ä»½ |

## Migration Plan

### æ•°æ®åº“è¿ç§»

```kotlin
val MIGRATION_2_3 = object : Migration(2, 3) {
    override fun migrate(database: SupportSQLiteDatabase) {
        // 1. åˆ›å»º embedding è¡¨
        database.execSQL("""
            CREATE TABLE IF NOT EXISTS memory_embeddings (
                memory_id INTEGER PRIMARY KEY NOT NULL,
                embedding_blob BLOB NOT NULL,
                model_version TEXT NOT NULL,
                created_at INTEGER NOT NULL,
                FOREIGN KEY (memory_id) REFERENCES image_memories(id) 
                    ON DELETE CASCADE
            )
        """)
        
        // 2. åˆ›å»ºç´¢å¼•
        database.execSQL("""
            CREATE INDEX IF NOT EXISTS index_memory_embeddings_model_version 
            ON memory_embeddings(model_version)
        """)
    }
}
```

### æ¸è¿›å¼å‘é‡ç”Ÿæˆ

```kotlin
// åå° Worker æ¸è¿›ç”Ÿæˆå‘é‡
class EmbeddingGenerationWorker : CoroutineWorker {
    override suspend fun doWork(): Result {
        val memoriesWithoutEmbedding = repo.getMemoriesWithoutEmbedding()
        
        memoriesWithoutEmbedding.forEach { memory ->
            val embedding = embeddingBridge.generate(memory.description)
            embeddingRepo.save(memory.id, embedding)
            
            // æ›´æ–°è¿›åº¦
            setProgress(workDataOf("progress" to progress))
        }
        
        return Result.success()
    }
}
```

### Rollback Plan

1. ä¿ç•™åŸæœ‰å…³é”®è¯æœç´¢é€»è¾‘
2. è¯­ä¹‰æœç´¢é€šè¿‡ Feature Flag æ§åˆ¶
3. å¦‚é‡ä¸¥é‡é—®é¢˜ï¼Œå¯å›é€€åˆ°çº¯å…³é”®è¯æ¨¡å¼

## Open Questions

1. **Q1**: æ˜¯å¦éœ€è¦æ”¯æŒæœç´¢å†å²è®°å½•ï¼Ÿ
   - å»ºè®®ï¼šv1.1 è€ƒè™‘ï¼Œæœ¬é˜¶æ®µå…ˆèšç„¦æ ¸å¿ƒæœç´¢

2. **Q2**: æ ‡ç­¾åˆå¹¶æ—¶å¦‚ä½•å¤„ç†å†²çªï¼Ÿ
   - å»ºè®®ï¼šæä¾› UI è®©ç”¨æˆ·ç¡®è®¤åˆå¹¶åçš„æ ‡ç­¾å

3. **Q3**: å‘é‡æ¨¡å‹å‡çº§æ—¶æ˜¯å¦éœ€è¦é‡æ–°ç”Ÿæˆæ‰€æœ‰å‘é‡ï¼Ÿ
   - å»ºè®®ï¼šæ˜¯ï¼Œé€šè¿‡ `model_version` å­—æ®µæ ‡è®°ï¼Œåå°å¢é‡æ›´æ–°

## References

- [all-MiniLM-L6-v2 Model Card](https://huggingface.co/sentence-transformers/all-MiniLM-L6-v2)
- [ONNX Runtime Mobile](https://onnxruntime.ai/docs/tutorials/mobile/)
- [Room Database Migration](https://developer.android.com/training/data-storage/room/migrating-db-versions)
- [Hybrid Search Strategies](https://www.pinecone.io/learn/hybrid-search/)
